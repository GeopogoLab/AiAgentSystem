<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥¶èŒ¶ç‚¹å• AI Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .chat-container {
            height: 400px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f9f9f9;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.assistant {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .message-label {
            font-size: 12px;
            margin-bottom: 5px;
            opacity: 0.7;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .mode-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
        }

        .input-area {
            display: flex;
            gap: 10px;
        }

        #textInput {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .record-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #e74c3c;
            color: white;
            font-size: 14px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .record-btn:hover {
            transform: scale(1.1);
        }

        .record-btn.recording {
            animation: pulse 1s infinite;
            background: #c0392b;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .status {
            text-align: center;
            margin-top: 15px;
            color: #666;
            font-size: 14px;
        }

        .order-info {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .order-info h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            color: #667eea;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§‹ å¥¶èŒ¶ç‚¹å• AI</h1>
        <p class="subtitle">è¯­éŸ³æˆ–æ–‡å­—ï¼Œè½»æ¾ç‚¹å•ï¼</p>

        <div class="chat-container" id="chatContainer">
            <div class="message assistant">
                <div class="message-label">AI æ¥å¾…å‘˜</div>
                <div>æ‚¨å¥½ï¼æ¬¢è¿å…‰ä¸´ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨ç‚¹å•ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³è¦ä»€ä¹ˆé¥®å“ï½</div>
            </div>
        </div>

        <div class="controls">
            <!-- æ¨¡å¼é€‰æ‹© -->
            <div class="mode-selector">
                <button class="mode-btn active" id="textModeBtn">æ–‡å­—æ¨¡å¼</button>
                <button class="mode-btn" id="voiceModeBtn">è¯­éŸ³æ¨¡å¼</button>
            </div>

            <!-- æ–‡å­—è¾“å…¥æ¨¡å¼ -->
            <div id="textMode">
                <div class="input-area">
                    <input
                        type="text"
                        id="textInput"
                        placeholder="è¾“å…¥æ‚¨çš„éœ€æ±‚..."
                        onkeypress="if(event.key==='Enter') sendText()"
                    />
                    <button class="btn btn-primary" onclick="sendText()">å‘é€</button>
                </div>
            </div>

            <!-- è¯­éŸ³è¾“å…¥æ¨¡å¼ -->
            <div id="voiceMode" class="hidden">
                <button class="record-btn" id="recordBtn" onclick="toggleRecording()">
                    <span id="recordText">æŒ‰ä½å½•éŸ³</span>
                </button>
                <input type="file" id="audioInput" accept="audio/*" class="hidden" onchange="uploadAudio()" />
                <div style="text-align: center; margin-top: 10px;">
                    <button class="btn btn-secondary" onclick="document.getElementById('audioInput').click()">
                        æˆ–ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶
                    </button>
                </div>
            </div>

            <div class="status" id="status"></div>

            <button class="btn btn-secondary" onclick="resetSession()" style="margin-top: 10px;">
                é‡æ–°å¼€å§‹
            </button>
        </div>

        <div class="order-info hidden" id="orderInfo">
            <h3>å½“å‰è®¢å•</h3>
            <div id="orderDetails"></div>
        </div>
    </div>

    <script>
        // é…ç½®
        const API_BASE_URL = 'http://localhost:8000';
        let sessionId = generateSessionId();
        let mediaRecorder = null;
        let audioChunks = [];

        // ç”Ÿæˆä¼šè¯ ID
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // æ¨¡å¼åˆ‡æ¢
        document.getElementById('textModeBtn').addEventListener('click', () => {
            document.getElementById('textMode').classList.remove('hidden');
            document.getElementById('voiceMode').classList.add('hidden');
            document.getElementById('textModeBtn').classList.add('active');
            document.getElementById('voiceModeBtn').classList.remove('active');
        });

        document.getElementById('voiceModeBtn').addEventListener('click', () => {
            document.getElementById('textMode').classList.add('hidden');
            document.getElementById('voiceMode').classList.remove('hidden');
            document.getElementById('textModeBtn').classList.remove('active');
            document.getElementById('voiceModeBtn').classList.add('active');
        });

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
        function addMessage(role, content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const label = role === 'user' ? 'æ‚¨' : 'AI æ¥å¾…å‘˜';
            messageDiv.innerHTML = `
                <div class="message-label">${label}</div>
                <div>${content}</div>
            `;

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(text) {
            document.getElementById('status').textContent = text;
        }

        // æ›´æ–°è®¢å•ä¿¡æ¯
        function updateOrderInfo(orderState) {
            const orderInfo = document.getElementById('orderInfo');
            const orderDetails = document.getElementById('orderDetails');

            if (!orderState.drink_name && !orderState.size) {
                orderInfo.classList.add('hidden');
                return;
            }

            orderInfo.classList.remove('hidden');
            orderDetails.innerHTML = '';

            if (orderState.drink_name) {
                orderDetails.innerHTML += `<div class="order-item"><span>é¥®å“ï¼š</span><span>${orderState.drink_name}</span></div>`;
            }
            if (orderState.size) {
                orderDetails.innerHTML += `<div class="order-item"><span>æ¯å‹ï¼š</span><span>${orderState.size}</span></div>`;
            }
            if (orderState.sugar) {
                orderDetails.innerHTML += `<div class="order-item"><span>ç”œåº¦ï¼š</span><span>${orderState.sugar}</span></div>`;
            }
            if (orderState.ice) {
                orderDetails.innerHTML += `<div class="order-item"><span>å†°å—ï¼š</span><span>${orderState.ice}</span></div>`;
            }
            if (orderState.toppings && orderState.toppings.length > 0) {
                orderDetails.innerHTML += `<div class="order-item"><span>åŠ æ–™ï¼š</span><span>${orderState.toppings.join('ã€')}</span></div>`;
            }
            if (orderState.notes) {
                orderDetails.innerHTML += `<div class="order-item"><span>å¤‡æ³¨ï¼š</span><span>${orderState.notes}</span></div>`;
            }
        }

        // å‘é€æ–‡æœ¬
        async function sendText() {
            const textInput = document.getElementById('textInput');
            const text = textInput.value.trim();

            if (!text) return;

            addMessage('user', text);
            textInput.value = '';
            updateStatus('æ­£åœ¨å¤„ç†...');

            try {
                const formData = new FormData();
                formData.append('session_id', sessionId);
                formData.append('text', text);

                const response = await fetch(`${API_BASE_URL}/text`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('è¯·æ±‚å¤±è´¥');
                }

                const data = await response.json();
                addMessage('assistant', data.assistant_reply);
                updateOrderInfo(data.order_state);
                updateStatus('');

                if (data.order_id) {
                    updateStatus(`è®¢å•å·²ä¿å­˜ï¼è®¢å•å·ï¼š#${data.order_id}`);
                }

            } catch (error) {
                console.error('Error:', error);
                updateStatus('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // å½•éŸ³åŠŸèƒ½
        async function toggleRecording() {
            const recordBtn = document.getElementById('recordBtn');
            const recordText = document.getElementById('recordText');

            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                // å¼€å§‹å½•éŸ³
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        await sendAudio(audioBlob);
                    };

                    mediaRecorder.start();
                    recordBtn.classList.add('recording');
                    recordText.textContent = 'åœæ­¢å½•éŸ³';
                    updateStatus('æ­£åœ¨å½•éŸ³...');

                } catch (error) {
                    console.error('Error accessing microphone:', error);
                    updateStatus('æ— æ³•è®¿é—®éº¦å…‹é£');
                }

            } else {
                // åœæ­¢å½•éŸ³
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                recordBtn.classList.remove('recording');
                recordText.textContent = 'æŒ‰ä½å½•éŸ³';
            }
        }

        // ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶
        async function uploadAudio() {
            const audioInput = document.getElementById('audioInput');
            const file = audioInput.files[0];

            if (!file) return;

            await sendAudio(file);
            audioInput.value = '';
        }

        // å‘é€éŸ³é¢‘
        async function sendAudio(audioBlob) {
            updateStatus('æ­£åœ¨è¯†åˆ«è¯­éŸ³...');

            try {
                const formData = new FormData();
                formData.append('session_id', sessionId);
                formData.append('audio', audioBlob, 'audio.webm');

                const response = await fetch(`${API_BASE_URL}/talk`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('è¯·æ±‚å¤±è´¥');
                }

                const data = await response.json();

                // æ˜¾ç¤ºè¯†åˆ«çš„æ–‡æœ¬ï¼ˆå¦‚æœæœ‰ï¼‰
                // addMessage('user', '[è¯­éŸ³è¾“å…¥]');

                addMessage('assistant', data.assistant_reply);
                updateOrderInfo(data.order_state);
                updateStatus('');

                if (data.order_id) {
                    updateStatus(`è®¢å•å·²ä¿å­˜ï¼è®¢å•å·ï¼š#${data.order_id}`);
                }

            } catch (error) {
                console.error('Error:', error);
                updateStatus('è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // é‡ç½®ä¼šè¯
        async function resetSession() {
            if (!confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿå½“å‰è®¢å•ä¿¡æ¯å°†è¢«æ¸…é™¤ã€‚')) {
                return;
            }

            try {
                await fetch(`${API_BASE_URL}/reset/${sessionId}`, {
                    method: 'POST'
                });

                // æ¸…ç©ºèŠå¤©è®°å½•
                document.getElementById('chatContainer').innerHTML = `
                    <div class="message assistant">
                        <div class="message-label">AI æ¥å¾…å‘˜</div>
                        <div>æ‚¨å¥½ï¼æ¬¢è¿å…‰ä¸´ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨ç‚¹å•ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³è¦ä»€ä¹ˆé¥®å“ï½</div>
                    </div>
                `;

                // éšè—è®¢å•ä¿¡æ¯
                document.getElementById('orderInfo').classList.add('hidden');
                updateStatus('ä¼šè¯å·²é‡ç½®');

            } catch (error) {
                console.error('Error:', error);
                updateStatus('é‡ç½®å¤±è´¥');
            }
        }
    </script>
</body>
</html>
